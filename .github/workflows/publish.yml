name: Publish Packages to pub.dev

on:
  workflow_dispatch:
    inputs:
      start_package:
        description: 'Package index to start from (0 to start from the beginning)'
        required: false
        default: '0'
  push:
    tags:
      # Matches tags like `2.9.1` and `3.0.0-alpha.1` or `3.0.0-rc.1`
      - '[0-9]+.[0-9]+.[0-9]+*'

permissions:
  id-token: write

jobs:
  publish:
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    name: Publish all packages
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: Read version files
        id: versions
        run: |
          echo "serverpod_version=$(cat SERVERPOD_VERSION)" >> $GITHUB_OUTPUT
          echo "dart_version=$(cat DART_VERSION)" >> $GITHUB_OUTPUT
          echo "flutter_version=$(cat FLUTTER_VERSION)" >> $GITHUB_OUTPUT
          echo "insights_devtools_version=$(cat INSIGHTS_DEVTOOLS_VERSION)" >> $GITHUB_OUTPUT

      - name: Get dependencies for CLI
        run: |
          cd tools/serverpod_cli
          dart pub get
          cd ${{ github.workspace }}

      - name: Update pubspecs
        run: |
          dart tools/serverpod_cli/bin/serverpod_cli.dart generate-pubspecs \
            --version "${{ steps.versions.outputs.serverpod_version }}" \
            --dart-version "${{ steps.versions.outputs.dart_version }}" \
            --flutter-version "${{ steps.versions.outputs.flutter_version }}" \
            --mode production

      - name: Download and extract devtools extension
        run: |
          DEST_DIR="${{ github.workspace }}/packages/serverpod/extension/devtools/build"
          if ! curl -fSL https://downloads.serverpod.dev/devtools-extension/serverpod-${{ steps.versions.outputs.insights_devtools_version }}.zip -o serverpod-insights-devtools.zip; then
            echo "ERROR: Failed to download devtools extension zip file"
            echo "URL: https://downloads.serverpod.dev/devtools-extension/serverpod-${{ steps.versions.outputs.insights_devtools_version }}.zip"
            echo "Version: ${{ steps.versions.outputs.insights_devtools_version }}"
            exit 1
          fi

          if ! unzip serverpod-insights-devtools.zip -d "$(dirname "$DEST_DIR")"; then
            echo "ERROR: Failed to unzip devtools extension file"
            rm -f serverpod-insights-devtools.zip
            exit 1
          fi

          rm serverpod-insights-devtools.zip

      - name: Publish packages
        run: |
          START_PACKAGE="${{ github.event.inputs.start_package || '0' }}"
          BASE="${{ github.workspace }}"
          PCOUNT=0
          SLEEP_TIME=5

          while read PACKAGE; do
            if (( PCOUNT >= START_PACKAGE )); then
              echo "### PUBLISH PACKAGE: $PCOUNT"
              echo "$PACKAGE"

              cd "$BASE/$PACKAGE"

              # Use force flag to skip confirmation prompt
              if dart pub publish --force; then
                echo "✓ Successfully published $PACKAGE"
              else
                echo ""
                echo "### PUBLISH FAILED: $PCOUNT"
                echo "Package: $PACKAGE"
                echo ""
                echo "To resume, run the workflow again with:"
                echo "  start_package: $PCOUNT"
                echo ""
                exit 1
              fi

              # Give pub.dev a chance to catch up between each package deployment
              sleep $SLEEP_TIME
            else
              echo "### SKIPPING PACKAGE: $PCOUNT - $PACKAGE"
            fi
            PCOUNT=$((PCOUNT + 1))
          done < "$BASE/PUBLISHABLE_PACKAGES"

          echo ""
          echo "✓ All packages published successfully!"
