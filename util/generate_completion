#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CLI_DIR="$SCRIPT_DIR/../tools/serverpod_cli"

TEMP_DIR=$(mktemp -d)
trap 'rm -rf "$TEMP_DIR"' EXIT

echo "Generating Carapace completion spec..."
dart run "$CLI_DIR/bin/serverpod_cli.dart" completion generate \
  -t carapace -f "$TEMP_DIR/serverpod.yaml"

echo "Embedding completion spec..."
dart run "$CLI_DIR/bin/serverpod_cli.dart" completion embed \
  -t carapace -f "$TEMP_DIR/serverpod.yaml" \
  -d "$CLI_DIR/lib/src/generated/"

echo "Done. Completion spec written to tools/serverpod_cli/lib/src/generated/completion_script_carapace.dart"
