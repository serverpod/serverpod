#!/bin/bash

if [ ! -f util/.serverpod_util_root ]; then
    echo "Run this script from the root of the Serverpod repository"
    echo "I.e. util/run_tests_integration_cloud"
    exit 1
fi

# Load local credentials if available
if [ -f "integrations/.env.test" ]; then
    echo "Loading credentials from integrations/.env.test"
    set -a
    source integrations/.env.test
    set +a
fi

exit_code=0
BASE=`pwd`

# Provider configurations: name|package|env_prefix
PROVIDERS=(
    "AWS S3|serverpod_cloud_storage_s3|AWS"
    "Cloudflare R2|serverpod_cloud_storage_r2|R2"
    "GCP|serverpod_cloud_storage_gcp|GCP"
)

echo "==================== Cloud Storage Integration Tests ===================="
echo ""

for provider_config in "${PROVIDERS[@]}"; do
    IFS='|' read -r name package env_prefix <<< "$provider_config"

    echo "=== $name Integration Tests ==="

    # Check for HMAC access key
    key_var="SERVERPOD_TEST_${env_prefix}_HMAC_ACCESS_KEY_ID"

    if [ -z "${!key_var}" ]; then
        echo "$name credentials not configured. Skipping."
        echo "Set ${key_var} and related variables to run these tests."
        echo ""
    else
        echo "$name credentials found. Running tests..."
        cd "$BASE/integrations/$package"
        dart pub get --no-precompile
        dart test test/integration --reporter=failures-only
        last_exit_code=$?

        if [ $last_exit_code != 0 ] && [ $last_exit_code != 79 ]; then
            exit_code=1
        fi
        echo ""
    fi
done

echo "========================================================================"

exit $exit_code
